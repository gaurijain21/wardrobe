<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Debug | Closet Couture Catwalk</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üîç Authentication Debug Page</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current Auth State</h2>
            <div id="auth-status" class="space-y-2">
                <p class="text-gray-600">Loading...</p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Console Logs</h2>
            <pre id="console-logs" class="bg-gray-50 p-4 rounded text-xs overflow-auto max-h-96 font-mono"></pre>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Actions</h2>
            <div class="space-x-4">
                <button id="check-auth" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Check Auth State
                </button>
                <button id="sign-in" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Sign In
                </button>
                <button id="sign-out" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Sign Out
                </button>
                <a href="index.html" class="inline-block px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, onUser, signInWithGoogle, signOutUser } from "./firebase.js";
        import { getRedirectResult } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const authStatus = document.getElementById('auth-status');
        const consoleLogsEl = document.getElementById('console-logs');
        let logBuffer = [];

        // Intercept console logs
        const originalLog = console.log;
        const originalError = console.error;
        
        function addLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] [${type}] ${args.join(' ')}`;
            logBuffer.push(line);
            if (logBuffer.length > 100) logBuffer.shift();
            consoleLogsEl.textContent = logBuffer.join('\n');
            consoleLogsEl.scrollTop = consoleLogsEl.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            addLog('LOG', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            addLog('ERROR', ...args);
        };

        function updateAuthStatus(user) {
            if (user) {
                authStatus.innerHTML = `
                    <div class="space-y-2">
                        <p class="text-green-600 font-semibold">‚úÖ User is signed in</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Display Name:</strong> ${user.displayName || 'N/A'}</p>
                        <p><strong>UID:</strong> ${user.uid}</p>
                        <p><strong>Photo URL:</strong> ${user.photoURL || 'N/A'}</p>
                        <p><strong>Email Verified:</strong> ${user.emailVerified}</p>
                    </div>
                `;
            } else {
                authStatus.innerHTML = `
                    <p class="text-red-600 font-semibold">‚ùå No user signed in</p>
                `;
            }
        }

        // Check for redirect result
        (async () => {
            console.log('Checking for redirect result...');
            try {
                const result = await getRedirectResult(auth);
                if (result?.user) {
                    console.log('‚úÖ Redirect sign-in successful:', result.user.email);
                } else {
                    console.log('No redirect result found');
                }
            } catch (error) {
                console.error('‚ùå Redirect error:', error);
            }
        })();

        // Listen for auth state
        onUser((user) => {
            console.log('Auth state changed:', user ? user.email : 'null');
            updateAuthStatus(user);
        });

        // Button handlers
        document.getElementById('check-auth').addEventListener('click', () => {
            const user = auth.currentUser;
            console.log('Current user from auth.currentUser:', user);
            console.log('Global currentAppUser:', window.currentAppUser);
            updateAuthStatus(user);
        });

        document.getElementById('sign-in').addEventListener('click', async () => {
            console.log('Initiating sign-in...');
            try {
                await signInWithGoogle();
            } catch (error) {
                console.error('Sign-in error:', error);
            }
        });

        document.getElementById('sign-out').addEventListener('click', async () => {
            console.log('Signing out...');
            try {
                await signOutUser();
                console.log('‚úÖ Signed out successfully');
            } catch (error) {
                console.error('Sign-out error:', error);
            }
        });

        console.log('Debug page loaded');
    </script>
</body>
</html>